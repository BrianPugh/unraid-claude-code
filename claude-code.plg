<?xml version='1.0' standalone='yes'?>

<PLUGIN name="claude-code" author="brianpugh" version="2025.11.27"
        pluginURL="https://raw.githubusercontent.com/brianpugh/unraid-claude-code/main/claude-code.plg"
        supportURL="https://forums.unraid.net/topic/XXXXX-claude-code/"
        icon="https://raw.githubusercontent.com/brianpugh/unraid-claude-code/main/claude-icon.png"
        min="6.12.0">

<CHANGES>
###2025.11.27
- Initial release
- Installs Claude Code CLI
- Persistent authentication via user-configurable appdata folder
</CHANGES>

<DESCRIPTION>
Claude Code CLI - AI-powered coding assistant from Anthropic.
Use Claude directly in your terminal for code generation, debugging, and more.
</DESCRIPTION>

<!-- Create directories -->
<FILE Run="/bin/bash">
<INLINE>
mkdir -p /boot/config/plugins/claude-code
mkdir -p /usr/local/emhttp/plugins/claude-code/scripts
</INLINE>
</FILE>

<!-- Configuration file -->
<FILE Name="/boot/config/plugins/claude-code/claude-code.cfg">
<INLINE>
# Claude Code Plugin Configuration
# Path to store Claude config (on array, not flash)
APPDATA_PATH="/mnt/user/appdata/claude-code"
</INLINE>
</FILE>

<!-- Install/setup script -->
<FILE Name="/usr/local/emhttp/plugins/claude-code/scripts/install-claude.sh" Mode="0755">
<INLINE>
<![CDATA[
#!/bin/bash

set -e

PLUGIN_CFG="/boot/config/plugins/claude-code/claude-code.cfg"
CLAUDE_CONFIG_RUNTIME="/root/.claude"

# Load config
source "$PLUGIN_CFG"

echo "=== Claude Code Installation ==="

install_nodejs() {
    if command -v node &> /dev/null; then
        echo "Node.js already installed: $(node --version)"
        return 0
    fi

    echo "Node.js not found. Attempting installation..."

    # Check if nerd-pack is available (preferred method)
    if [ -f /boot/config/plugins/nerd-pack/nerd-pack.cfg ]; then
        echo "NerdTools detected. Please enable Node.js in NerdTools settings."
        echo "Settings -> Nerd Tools -> Node.js"
        return 1
    fi

    # Direct installation fallback - download Node.js binary
    echo "Downloading Node.js..."
    NODE_VERSION="${NODE_VERSION:-22}"
    NODE_DIR="/usr/local/node"

    mkdir -p "$NODE_DIR"

    # Detect architecture
    ARCH=$(uname -m)
    case "$ARCH" in
        x86_64) NODE_ARCH="x64" ;;
        aarch64) NODE_ARCH="arm64" ;;
        *) echo "Unsupported architecture: $ARCH"; return 1 ;;
    esac

    NODE_TARBALL="node-v${NODE_VERSION}.0.0-linux-${NODE_ARCH}.tar.xz"
    NODE_URL="https://nodejs.org/dist/v${NODE_VERSION}.0.0/${NODE_TARBALL}"

    cd /tmp
    if ! wget -q --show-progress "$NODE_URL" -O "$NODE_TARBALL"; then
        echo "Failed to download Node.js. Trying latest LTS..."
        NODE_URL="https://nodejs.org/dist/latest-v${NODE_VERSION}.x/"
        echo "Please install Node.js manually or use NerdTools plugin."
        return 1
    fi

    tar -xf "$NODE_TARBALL" -C "$NODE_DIR" --strip-components=1
    rm -f "$NODE_TARBALL"

    # Add to PATH for current session
    export PATH="$NODE_DIR/bin:$PATH"

    # Create symlinks
    ln -sf "$NODE_DIR/bin/node" /usr/local/bin/node
    ln -sf "$NODE_DIR/bin/npm" /usr/local/bin/npm
    ln -sf "$NODE_DIR/bin/npx" /usr/local/bin/npx

    echo "Node.js installed: $(node --version)"
}

install_claude_code() {
    # Check if claude works (not just exists)
    if command -v claude &> /dev/null && claude --version &> /dev/null; then
        echo "Claude Code already installed: $(claude --version 2>/dev/null)"
        return 0
    fi

    # Remove stale symlink/file if it exists but doesn't work
    if [ -e /usr/local/bin/claude ] || [ -L /usr/local/bin/claude ]; then
        echo "Removing stale claude binary..."
        rm -f /usr/local/bin/claude
    fi

    echo "Installing Claude Code via npm..."
    npm install -g @anthropic-ai/claude-code

    # Verify installation
    if command -v claude &> /dev/null; then
        echo "Claude Code installed successfully!"
    else
        # May need to find where npm installed it
        NPM_BIN=$(npm bin -g 2>/dev/null)
        if [ -n "$NPM_BIN" ] && [ -f "$NPM_BIN/claude" ]; then
            ln -sf "$NPM_BIN/claude" /usr/local/bin/claude
            echo "Claude Code installed and linked."
        else
            echo "WARNING: Claude Code installed but not in PATH"
        fi
    fi
}

setup_auth_persistence() {
    echo "Setting up authentication persistence..."
    echo "Appdata path: $APPDATA_PATH"

    # Check if array is available
    if [ ! -d "/mnt/user" ]; then
        echo "WARNING: Array not started. Auth persistence will be configured when array starts."
        return 0
    fi

    # Create appdata directory if it doesn't exist
    mkdir -p "$APPDATA_PATH"

    # If runtime config exists but is not a symlink, migrate it
    if [ -d "$CLAUDE_CONFIG_RUNTIME" ] && [ ! -L "$CLAUDE_CONFIG_RUNTIME" ]; then
        echo "Migrating existing Claude config to appdata..."
        if [ -d "$APPDATA_PATH/.claude" ]; then
            # Merge: appdata takes precedence, but copy any missing files from runtime
            cp -an "$CLAUDE_CONFIG_RUNTIME"/* "$APPDATA_PATH/.claude/" 2>/dev/null || true
        else
            mv "$CLAUDE_CONFIG_RUNTIME" "$APPDATA_PATH/.claude"
        fi
        rm -rf "$CLAUDE_CONFIG_RUNTIME"
    fi

    # Create .claude directory in appdata if needed
    mkdir -p "$APPDATA_PATH/.claude"

    # Remove existing symlink or directory
    rm -rf "$CLAUDE_CONFIG_RUNTIME"

    # Create symlink
    ln -sf "$APPDATA_PATH/.claude" "$CLAUDE_CONFIG_RUNTIME"

    echo "Auth persistence configured: $CLAUDE_CONFIG_RUNTIME -> $APPDATA_PATH/.claude"
}

# Main
install_nodejs || {
    echo "ERROR: Failed to install Node.js"
    echo "Please install NerdTools plugin and enable Node.js, then reinstall this plugin."
    exit 1
}

install_claude_code || {
    echo "ERROR: Failed to install Claude Code"
    exit 1
}

setup_auth_persistence

echo ""
echo "=== Installation Complete ==="
echo "Run claude to start using Claude Code."
echo "Your authentication will persist in: $APPDATA_PATH"
]]>
</INLINE>
</FILE>

<!-- Web UI -->
<FILE Name="/usr/local/emhttp/plugins/claude-code/claude-code.page">
<INLINE>
<![CDATA[
Menu="Utilities"
Title="Claude Code"
Icon="terminal"
---
<?php
$plugin_dir = "/boot/config/plugins/claude-code";
$cfg_file = "$plugin_dir/claude-code.cfg";

$cfg = file_exists($cfg_file) ? parse_ini_file($cfg_file) : [];
$appdata_path = $cfg['APPDATA_PATH'] ?? '/mnt/user/appdata/claude-code';
$auth_dir = "$appdata_path/.claude";
$has_auth = is_dir($auth_dir);

// Check if array is started
$array_started = is_dir("/mnt/user");

// Check if claude is installed
$claude_installed = trim(shell_exec("which claude 2>/dev/null")) !== "";
$node_version = trim(shell_exec("node --version 2>/dev/null")) ?: "Not installed";

// Check symlink status
$symlink_target = is_link("/root/.claude") ? readlink("/root/.claude") : null;
$symlink_ok = $symlink_target === "$appdata_path/.claude";
?>

<style>
.status-ok { color: green; font-weight: bold; }
.status-warn { color: orange; font-weight: bold; }
.status-error { color: red; font-weight: bold; }
.code-block {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 5px;
    font-family: monospace;
    margin: 10px 0;
}
.section { margin-bottom: 20px; }
</style>

<div style="padding: 20px;">
    <h2>Claude Code</h2>
    <p>Claude Code CLI for Unraid - AI-powered coding assistant in your terminal.</p>

    <div class="section">
        <h3>Status</h3>
        <table>
            <tr>
                <td><strong>Node.js:</strong></td>
                <td><?= $node_version !== "Not installed"
                    ? "<span class='status-ok'>$node_version</span>"
                    : "<span class='status-error'>$node_version</span>" ?></td>
            </tr>
            <tr>
                <td><strong>Claude Code:</strong></td>
                <td><?= $claude_installed
                    ? "<span class='status-ok'>Installed</span>"
                    : "<span class='status-error'>Not installed</span>" ?></td>
            </tr>
            <tr>
                <td><strong>Array:</strong></td>
                <td><?= $array_started
                    ? "<span class='status-ok'>Started</span>"
                    : "<span class='status-error'>Not started</span>" ?></td>
            </tr>
            <tr>
                <td><strong>Authentication:</strong></td>
                <td><?= $has_auth
                    ? "<span class='status-ok'>Configured</span>"
                    : "<span class='status-warn'>Not authenticated</span>" ?></td>
            </tr>
            <tr>
                <td><strong>Symlink:</strong></td>
                <td><?= $symlink_ok
                    ? "<span class='status-ok'>OK</span>"
                    : "<span class='status-warn'>Not configured</span>" ?></td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h3>Settings</h3>
        <form method="POST" action="/update.php" target="progressFrame">
            <input type="hidden" name="#file" value="<?= $cfg_file ?>">
            <input type="hidden" name="#command" value="/usr/local/emhttp/plugins/claude-code/scripts/install-claude.sh">

            <dl>
                <dt>Appdata Path:</dt>
                <dd>
                    <input type="text" name="APPDATA_PATH" value="<?= htmlspecialchars($appdata_path) ?>" size="50">
                </dd>
            </dl>
            <dl>
                <dt>&nbsp;</dt>
                <dd>
                    <input type="submit" value="Apply">
                    <input type="button" value="Done" onclick="done()">
                </dd>
            </dl>
        </form>
        <p><em>Store Claude config on your array to avoid flash wear.</em></p>
    </div>

    <div class="section">
        <h3>Usage</h3>
        <p>Open the Unraid terminal and run:</p>
        <div class="code-block">claude</div>
        <p style="margin-top: 10px;">
            <input type="button" value="Launch Claude" onclick="window.open('/webterminal/?cmd=claude', '_blank')">
        </p>
    </div>

    <?php if (!$has_auth): ?>
    <div class="section">
        <h3>First-Time Setup</h3>
        <ol>
            <li>Make sure the array is started</li>
            <li>Open terminal and run <code>claude</code></li>
            <li>Follow the authentication prompts</li>
            <li>Your credentials are automatically saved to the appdata folder</li>
        </ol>
    </div>
    <?php endif; ?>

    <div class="section">
        <h3>Reinstall Claude Code</h3>
        <form method="POST" action="/update.php" target="progressFrame">
            <input type="hidden" name="#command" value="/usr/local/emhttp/plugins/claude-code/scripts/install-claude.sh">
            <input type="submit" value="Reinstall">
        </form>
    </div>
</div>
]]>
</INLINE>
</FILE>

<!-- Startup script (runs on boot) -->
<FILE Name="/usr/local/emhttp/plugins/claude-code/event/starting_svcs" Mode="0755">
<INLINE>
<![CDATA[
#!/bin/bash

# Runs on every Unraid boot to restore Claude Code and setup symlink

echo "Claude Code: Starting services..."

# Run the install script (handles both fresh install and symlink setup)
/usr/local/emhttp/plugins/claude-code/scripts/install-claude.sh

echo "Claude Code: Ready."
]]>
</INLINE>
</FILE>

<!-- Post-install -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
/usr/local/emhttp/plugins/claude-code/scripts/install-claude.sh

echo ""
echo "-----------------------------------------------------------"
echo " Claude Code plugin v2025.11.27 has been installed!"
echo ""
echo " To use: Open terminal and run: claude"
echo " Web UI: Settings -> Utilities -> Claude Code"
echo ""
echo " Your Claude config will be stored at:"
echo "   /mnt/user/appdata/claude-code/.claude"
echo " (configurable in the web UI)"
echo "-----------------------------------------------------------"
echo ""
]]>
</INLINE>
</FILE>

<!-- Removal -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
<![CDATA[
echo "Removing Claude Code plugin..."

# Remove symlink
rm -f /root/.claude

# Remove npm package
npm uninstall -g @anthropic-ai/claude-code 2>/dev/null || true

# Remove plugin runtime files
rm -rf /usr/local/emhttp/plugins/claude-code
rm -f /usr/local/bin/claude

# Note: We keep config and appdata for potential reinstall
echo ""
echo "Claude Code removed."
echo "Config preserved at: /boot/config/plugins/claude-code/"
echo "Auth data preserved at your appdata location."
echo "Delete manually if you want a complete removal."
]]>
</INLINE>
</FILE>

</PLUGIN>
